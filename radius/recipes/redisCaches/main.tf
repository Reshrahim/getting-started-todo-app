# Radius Recipe: Azure Cache for Redis (AVM)
# Auto-generated by rad app generate
# Uses Azure Verified Module: avm/res/cache/redis

terraform {
  required_version = ">= 1.5.0"

  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = ">= 3.71.0"
    }
    random = {
      source  = "hashicorp/random"
      version = ">= 3.5.0"
    }
  }
}

provider "azurerm" {
  features {}
}

variable "context" {
  description = "Radius-provided context for the recipe"
  type        = any
}

locals {
  name              = var.context.resource.name
  tags              = try(var.context.resource.tags, {})
  resource_group    = try(var.context.azure.resourceGroup.name, "radius-${var.context.environment.name}")
  location          = try(var.context.azure.location, "eastus")
  sku_name          = "Basic"
  capacity          = 0
  enable_non_ssl    = true
}

resource "random_string" "suffix" {
  length  = 8
  special = false
  upper   = false
}

# Azure Cache for Redis using AVM module
module "redis" {
  source  = "Azure/avm-res-cache-redis/azurerm"
  version = "~> 0.1"

  name                = "${local.name}-${random_string.suffix.result}"
  resource_group_name = local.resource_group
  location            = local.location
  sku_name            = local.sku_name
  capacity            = local.capacity
  enable_non_ssl_port = local.enable_non_ssl

  tags = merge(local.tags, {
    "radapp.io/resource"    = var.context.resource.id
    "radapp.io/environment" = var.context.environment.id
  })
}

output "result" {
  description = "Recipe output values for Radius"
  sensitive   = true
  value = {
    values = {
      host       = module.redis.hostname
      port       = local.enable_non_ssl ? 6379 : 6380
      tls        = !local.enable_non_ssl
      password   = module.redis.primary_access_key
      connection = module.redis.primary_connection_string
    }
    secrets = {
      password   = module.redis.primary_access_key
      connection = module.redis.primary_connection_string
    }
    resources = [
      module.redis.resource_id
    ]
  }
}
